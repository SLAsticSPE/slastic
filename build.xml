<?xml version="1.0" encoding="UTF-8"?>
<project name="SLAstic" default="build-all" basedir=".">
    <property file="build.properties"/>
    <property file="examples.properties"/>

    <path id="classpath.libs">
        <pathelement path="${classpath}"/>
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="."/>
    </path>

    <target name="init-version">
        <tstamp/>
        <!-- Names of the slastic runtime libraries that will be created
             by the build process: -->
        <property name="slastic.version"
                  value="0.01a"/>
        <property name="slastic.core.jar"
                  value="${slastic.core.packagenamebase}-${slastic.version}.jar"/>
        <!--<property name="slastic.monitoring.jar"
                  value="${slastic.monitoring.packagenamebase}-${slastic.version}.jar"/>
        <property name="slastic.control.jar"
                  value="${slastic.control.packagenamebase}-${slastic.version}.jar"/>-->
        <property name="slastic.simulation.jar"
                  value="${slastic.simulation.packagenamebase}-${slastic.version}.jar"/>
        <!--<property name="slastic.reconfiguration.jar"
                  value="${slastic.reconfiguration.packagenamebase}-${slastic.version}.jar"/>-->
        <property name="slastic.plugins.jar"
                  value="${slastic.plugins.packagenamebase}-${slastic.version}.jar"/>
        </target>

    <target name="update-version" unless="version.noupdate"
            depends="init-version">
        <echo>Updating version string</echo>
        <replaceregexp file="src/core/org/trustsoft/slastic/common/Version.java"
                       match="VERSION = &quot;.*?&quot;"
                       replace="VERSION = &quot;${slastic.version}-${DSTAMP}&quot;"/>
        <replaceregexp match="&lt;version&gt;.*?&lt;/version&gt;"
                       replace="&lt;version&gt;${slastic.version}-${DSTAMP}&lt;/version&gt;">
            <fileset dir=".">
                <include name="pom_ant_slastic*.xml"/>
            </fileset>
        </replaceregexp>
    </target>

<!--    <target name="build-all"
            depends="clean,init,build-slastic.core,build-slastic.monitoring,build-slastic.control,build-slastic.simulation,build-slastic.reconfiguration">
    </target>-->

    <!-- TODO: plugins -->
    <target name="build-all"
            depends="clean,init,build-slastic.core,build-slastic.simulation,build-slastic.plugins">
    </target>
    
    <condition property="no.slastic.properties">
        <not>
            <available file="${slastic.monitoring.properties}"/>
        </not>
    </condition>

    <target name="init-slastic.properties" if="no.slastic.properties">
        <!-- if no slastic.properties, copy example file automatically  -->
        <echo message="${slastic.properties} not existing.
              Creating default file."/>
        <copy file="${slastic.properties.example}" tofile="${slastic.properties}"/>
    </target>

    <condition property="no.slastic.simulation.properties">
        <not>
            <available file="${slastic.simulation.properties}"/>
        </not>
    </condition>

    <target name="init-slastic.simulation-properties" if="no.slastic.simulation.properties">
        <!-- if no slastic.simulation.properties, copy example file automatically  -->
        <echo message="${slastic.simulation.properties} not existing.
              Creating default file."/>
        <copy file="${slastic.simulation.properties.example}" tofile="${slastic.simulation.properties}"/>
    </target>

    <target name="init" depends="update-version,init-slastic.properties,init-slastic.simulation-properties">
        <!-- Register special aspectJ commands in ant - allow ant to use special AspectJ commands: -->
        <taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties" classpath="${aspectjtoolsjar}"/>
        <fail message="Critical error: AspectJ library not found
              in ${aspectjtoolsjar}.
              Check your build.properties.">
            <condition>
                <not>
                    <available file="${aspectjtoolsjar}"/>
                </not>
            </condition>
        </fail>
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${dist.dir}"/>
        <mkdir dir="${build.tests.dir}"/>
        <mkdir dir="tmp"/>

        <path id="slastic.core.classpath">
        <path refid="classpath.libs"/>
            <fileset dir="${dist.dir}">
                <include name="${slastic.core.jar}"/>
            </fileset>
        </path>

        <path id="run.tests.classpath">
        <path refid="slastic.core.classpath"/>
            <pathelement location="${build.tests.dir}/"/>
        </path>
    </target>

    <target name="build-slastic.core" depends="init">
        <delete dir="${build.slastic.core.dir}"/>
        <mkdir  dir="${build.slastic.core.dir}"/>
        <mkdir  dir="${build.slastic.core.dir}/META-INF"/>
        <javac destDir="${build.slastic.core.dir}"
               source="1.5"
               srcdir="src/core"
               debug="true"
               classpathref="classpath.libs">
            <compilerarg value="-Xlint:-path"/>
            <!--<include name="org/trustsoft/slastic/core/**"/>-->
        </javac>
        <!--<copy file="${slastic.core.properties}" todir="${build.slastic.core.dir}/META-INF"/>-->
        <!-- We want to include the sources in this jar -->
        <copy todir="${build.slastic.core.dir}/">
            <fileset dir="src/core">
                <include name="org/trustsoft/slastic/core/**/*.java"/>
            </fileset>
        </copy>
        <jar destfile="${dist.dir}/${slastic.core.jar}">
            <fileset dir="${build.slastic.core.dir}"/>
        </jar>
    </target>
    
    <target name="build-slastic.plugins" depends="init">
        <delete dir="${build.slastic.plugins.dir}"/>
        <mkdir  dir="${build.slastic.plugins.dir}"/>
        <mkdir  dir="${build.slastic.plugins.dir}/META-INF"/>
        <javac destDir="${build.slastic.plugins.dir}"
               source="1.5"
               srcdir="src/plugins"
               debug="true"
               classpathref="slastic.core.classpath">
            <compilerarg value="-Xlint:-path"/>
            <!--<include name="org/trustsoft/slastic/plugins/**"/>-->
        </javac>
        <!--<copy file="${slastic.plugins.properties}" todir="${build.slastic.plugins.dir}/META-INF"/>-->
        <!-- We want to include the sources in this jar -->
        <copy todir="${build.slastic.plugins.dir}/">
            <fileset dir="src/plugins">
                <include name="org/trustsoft/slastic/plugins/**/*.java"/>
            </fileset>
        </copy>
        <jar destfile="${dist.dir}/${slastic.plugins.jar}">
            <fileset dir="${build.slastic.plugins.dir}"/>
        </jar>
    </target>
    
    <target name="build-slastic.simulation" depends="init">
        <delete dir="${build.slastic.simulation.dir}"/>
        <mkdir  dir="${build.slastic.simulation.dir}"/>
        <mkdir  dir="${build.slastic.simulation.dir}/META-INF"/>
        <javac destDir="${build.slastic.simulation.dir}"
               source="1.5"
               srcdir="src/simulation"
               debug="true"
               classpathref="classpath.libs">
            <compilerarg value="-Xlint:-path"/>
            <include name="org/trustsoft/slastic/simulation/**"/>
        </javac>
        <copy file="${slastic.simulation.properties}" todir="${build.slastic.simulation.dir}/META-INF"/>
        <!-- We want to include the sources in this jar -->
        <copy todir="${build.slastic.simulation.dir}/">
            <fileset dir="src/simulation">
                <include name="org/trustsoft/slastic/simulation/**/*.java"/>
            </fileset>
        </copy>
        <jar destfile="${dist.dir}/${slastic.simulation.jar}">
            <fileset dir="${build.slastic.simulation.dir}"/>
        </jar>
    </target>

    <condition property="no.log4j.properties.tests">
        <not>
            <available file="${tests.log4j.properties}"/>
        </not>
    </condition>

    <target name="init-log4-properties-tests" if="no.log4j.properties.tests">
        <!-- if no aop.xml, copy example file automatically  -->
        <echo message="${no.log4j.properties.tests} not existing.
              Creating default file."/>
        <copy file="${log4j.properties.example}" tofile="${tests.log4j.properties}"/>
    </target>

    <target name="run-SLAsticControl" depends="build-slastic.core,init-log4-properties-tests">
        <copy file="${tests.log4j.properties}" tofile="${build.dir}/tests.log4j.properties"/>
        <java dir="."
              fork="true"
              classname="org.trustsoft.slastic.SLAsticStarter"
              classpathref="slastic.control.core.classpath"
              maxmemory="1024m">
            <jvmarg value="-DinputDir=${inputDir}"/>
            <jvmarg value="-Dlog4j.configuration=${build.dir}/tests.log4j.properties"/>
            <jvmarg value="-Dtpmon.configuration=${slastic.control.tpmon.properties}"/>
            <classpath>
                <pathelement location="${dist.dir}/${slastic.monitoring.jar}"/>
            </classpath>
        </java>
        <delete file="${build.tests.dir}/log4j.properties"/>
    </target>

    <target name="run-Example-jpetstore" depends="build-slastic.core,init-log4-properties-tests">
        <copy file="${tests.log4j.properties}" tofile="${build.dir}/tests.log4j.properties"/>
        <java dir="."
              fork="true"
              classname="org.trustsoft.slastic.SLAsticStarter"
              classpathref="slastic.control.core.classpath"
              maxmemory="1024m">
            <jvmarg value="-Dreader=JMS"/>
            <jvmarg value="-Dexample=JPetStore"/>
            <!--<jvmarg value="-DinputDir=${inputDir}"/>-->
            <jvmarg value="-DinitWorkflow=${jpetstore.initWorkflow}"/>
            <jvmarg value="-Dlog4j.configuration=${build.dir}/tests.log4j.properties"/>
            <jvmarg value="-Dtpmon.configuration=${slastic.control.tpmon.properties}"/>
            <classpath>
                <pathelement location="${dist.dir}/${slastic.monitoring.jar}"/>
            </classpath>
        </java>
        <delete file="${build.tests.dir}/log4j.properties"/>
    </target>

    <target name="run-Example-bookstore" depends="build-slastic.core,init-log4-properties-tests">
        <copy file="${tests.log4j.properties}" tofile="${build.dir}/tests.log4j.properties"/>
        <java dir="."
              fork="true"
              classname="org.trustsoft.slastic.SLAsticStarter"
              classpathref="slastic.control.core.classpath"
              maxmemory="1024m">
            <jvmarg value="-Dreader=FSRealtime"/>
            <jvmarg value="-Dexample=Bookstore"/>
            <jvmarg value="-DinputDir=${inputDir}"/>
            <jvmarg value="-DinitWorkflow=${bookstore.initWorkflow}"/>
            <jvmarg value="-Dlog4j.configuration=${build.dir}/tests.log4j.properties"/>
            <jvmarg value="-Dtpmon.configuration=${slastic.control.tpmon.properties}"/>
            <classpath>
                <pathelement location="${dist.dir}/${slastic.monitoring.jar}"/>
            </classpath>
        </java>
        <delete file="${build.tests.dir}/log4j.properties"/>
    </target>

    <target name="run-SLAsticControl-plain" depends="build-slastic.core,init-log4-properties-tests">
        <copy file="${tests.log4j.properties}" tofile="${build.dir}/tests.log4j.properties"/>
        <java dir="."
              fork="true"
              classname="org.trustsoft.slastic.common.SLAsticStarter"
              classpathref="slastic.control.core.classpath"
              maxmemory="1024m">
            <jvmarg value="-Dlog4j.configuration=${build.dir}/tests.log4j.properties"/>
            <jvmarg value="-Dtpmon.configuration=${slastic.control.tpmon.properties}"/>
            <arg line="--configuration META-INF/slastic.control.properties.example"/>
            <classpath>
                <pathelement location="${dist.dir}/${slastic.monitoring.jar}"/>
            </classpath>
        </java>
        <delete file="${build.tests.dir}/log4j.properties"/>
    </target>

    <target name="run-SLAsticControl-newconfig" depends="build-slastic.core,build-slastic.plugins,init-log4-properties-tests">
        <copy file="${tests.log4j.properties}" tofile="${build.dir}/tests.log4j.properties"/>
        <java dir="."
              fork="true"
              classname="org.trustsoft.slastic.common.SLAsticStarter"
              classpathref="slastic.core.classpath"
              maxmemory="1024m">
            <jvmarg value="-Dlog4j.configuration=${build.dir}/tests.log4j.properties"/>
            <jvmarg value="-Dtpmon.configuration=${slastic.control.tpmon.properties}"/>
            <arg line="--isnewconfig true"/>
            <arg line="--configuration META-INF/slastic.properties.example"/>
            <classpath>
                <pathelement location="${dist.dir}/${slastic.plugins.jar}"/>
            </classpath>
        </java>
        <delete file="${build.tests.dir}/log4j.properties"/>
    </target>
    
    <condition property="no.log4j.properties.tests">
        <not>
            <available file="${tests.log4j.properties}"/>
        </not>
    </condition>

    <target name="compile-tests-loadTimeWeavingDifferentRecordTypes"
            depends="build-slastic.core,init-log4-properties-tests">
        <javac source="1.5"
               destDir="${build.tests.dir}"
               classpathref="slastic.control.core.classpath"
               srcdir="src/org/trustsoft/slastic/tests/bookstoreDifferentRecordTypes">
        </javac>
        <copy file="${tests.log4j.properties}"
              tofile="${build.dir}/tests.log4j.properties"/>
        <copy file="${aop.xml.ltwtests}"
              tofile="${build.tests.dir}/META-INF/aop.xml"/>
    </target>

    <target name="run-tests-loadTimeWeaving-bookstoreDifferentRecordTypes"
            depends="compile-tests-loadTimeWeavingDifferentRecordTypes">
        <java dir="."
              fork="true"
              classname="org.trustsoft.slastic.tests.bookstoreDifferentRecordTypes.Bookstore"
              classpathref="run.tests.classpath">
            <jvmarg value="-Dtpmon.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}"/>
            <jvmarg value="-Dtpmon.customStoragePath=${tests.logdata.storagepath}"/>
            <jvmarg value="-javaagent:${aspectjweaverjar}"/>
            <jvmarg value="-Dlog4j.configuration=${build.dir}/tests.log4j.properties"/>
            <jvmarg value="-Dorg.aspectj.weaver.showWeaveInfo=true"/>
            <jvmarg value="-Daj.weaving.verbose=true"/>
            <classpath>
                <pathelement location="${dist.dir}/${dist.tpmon.ltw}"/>
                <pathelement location="${dist.dir}/${slastic.control.jar}"/>
                <pathelement location="${dist.dir}/${slastic.monitoring.jar}"/>
            </classpath>
        </java>
    </target>

    <target name="clean">
        <!-- <delete dir="tmp"/>-->
        <delete dir="${dist.dir}"/>
        <delete dir="${build.dir}"/>
    </target>
</project>
